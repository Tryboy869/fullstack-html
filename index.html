<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>eval() API - Service Worker Bridge</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      text-align: center;
    }
    
    header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .status {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      margin: 10px 5px;
    }
    
    .status.active {
      background: #27ae60;
      color: white;
    }
    
    .status.inactive {
      background: #e74c3c;
      color: white;
    }
    
    main {
      padding: 40px;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 15px;
      border-left: 5px solid #667eea;
    }
    
    .section h2 {
      color: #667eea;
      margin-bottom: 15px;
    }
    
    .card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-top: 15px;
    }
    
    .endpoint {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      margin: 10px 0;
      border-left: 4px solid #27ae60;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin: 5px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    button.success {
      background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    }
    
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 13px;
      margin: 10px 0;
    }
    
    .output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      min-height: 100px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 15px;
      white-space: pre-wrap;
    }
    
    .badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.85em;
      font-weight: 600;
      margin: 5px;
    }
    
    .badge.success {
      background: #d4edda;
      color: #155724;
    }
    
    .badge.warning {
      background: #fff3cd;
      color: #856404;
    }
    
    code {
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      color: #e74c3c;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üöÄ eval() API - Service Worker Bridge</h1>
      <p>API HTTP r√©elle propuls√©e par eval() c√¥t√© client</p>
      <div>
        <span class="status" id="swStatus">‚è≥ Initialisation...</span>
        <span class="status" id="apiStatus">‚è≥ En attente...</span>
      </div>
    </header>

    <main>
      <!-- Section 1: Instructions -->
      <div class="section">
        <h2>üìñ Comment √ßa marche ?</h2>
        <div class="card">
          <h3>Architecture Innovante</h3>
          <p><strong>Service Worker</strong> agit comme un serveur HTTP local qui intercepte les requ√™tes et ex√©cute eval() de mani√®re s√©curis√©e.</p>
          
          <ol style="margin: 15px 0 15px 25px; line-height: 1.8;">
            <li><strong>Service Worker enregistr√©</strong> ‚Üí Intercepte toutes les requ√™tes vers <code>/api/*</code></li>
            <li><strong>Requ√™te re√ßue</strong> ‚Üí Parse JSON et extrait le code √† ex√©cuter</li>
            <li><strong>eval() s√©curis√©</strong> ‚Üí Ex√©cution dans sandbox avec whitelist</li>
            <li><strong>R√©ponse JSON</strong> ‚Üí R√©sultat retourn√© comme une vraie API</li>
          </ol>
          
          <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <strong>‚ö†Ô∏è Important :</strong> Cette page doit √™tre servie en <strong>HTTPS</strong> pour que le Service Worker fonctionne (sauf sur localhost).
          </div>
        </div>
      </div>

      <!-- Section 2: Endpoints disponibles -->
      <div class="section">
        <h2>‚ö° Endpoints API Disponibles</h2>
        <div class="card">
          <h3>1. Ex√©cuter du code eval()</h3>
          <div class="endpoint">POST /api/eval</div>
          <pre>{
  "code": "return Math.sqrt(144);"
}</pre>
          <button class="success" onclick="testEvalEndpoint()">üß™ Tester</button>
        </div>
        
        <div class="card">
          <h3>2. Charger un plugin</h3>
          <div class="endpoint">POST /api/plugin/load</div>
          <pre>{
  "name": "MathPlugin",
  "code": "({ add: (a,b) => a+b })"
}</pre>
          <button class="success" onclick="testPluginLoad()">üß™ Tester</button>
        </div>
        
        <div class="card">
          <h3>3. Appeler un plugin</h3>
          <div class="endpoint">POST /api/plugin/call</div>
          <pre>{
  "plugin": "MathPlugin",
  "method": "add",
  "args": [5, 3]
}</pre>
          <button class="success" onclick="testPluginCall()">üß™ Tester</button>
        </div>
        
        <div class="card">
          <h3>4. Health check</h3>
          <div class="endpoint">GET /api/health</div>
          <button class="success" onclick="testHealth()">üß™ Tester</button>
        </div>
      </div>

      <!-- Section 3: Test depuis Colab -->
      <div class="section">
        <h2>üêç Code Python pour Google Colab</h2>
        <div class="card">
          <h3>Copiez ce code dans Colab</h3>
          <pre id="pythonCode">import requests
import json

# URL de votre app d√©ploy√©e
BASE_URL = "https://VOTRE-APP.onrender.com"

# Test 1: Health check
response = requests.get(f"{BASE_URL}/api/health")
print("Health:", response.json())

# Test 2: Ex√©cuter eval()
response = requests.post(
    f"{BASE_URL}/api/eval",
    json={"code": "return Math.pow(2, 10);"}
)
print("Eval r√©sultat:", response.json())

# Test 3: Charger plugin
response = requests.post(
    f"{BASE_URL}/api/plugin/load",
    json={
        "name": "Calculator",
        "code": "({add: (a,b) => a+b, multiply: (a,b) => a*b})"
    }
)
print("Plugin charg√©:", response.json())

# Test 4: Appeler plugin
response = requests.post(
    f"{BASE_URL}/api/plugin/call",
    json={
        "plugin": "Calculator",
        "method": "multiply",
        "args": [7, 6]
    }
)
print("Plugin r√©sultat:", response.json())</pre>
          <button onclick="copyPythonCode()">üìã Copier le code Python</button>
        </div>
      </div>

      <!-- Section 4: Logs -->
      <div class="section">
        <h2>üìä Logs en Temps R√©el</h2>
        <div class="card">
          <div id="logs" class="output">Initialisation...</div>
          <button onclick="clearLogs()">üóëÔ∏è Effacer</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    const logs = [];
    
    function log(message, type = 'info') {
      const timestamp = new Date().toISOString();
      const symbols = { info: '‚ÑπÔ∏è', success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è' };
      const symbol = symbols[type] || '‚ÑπÔ∏è';
      
      const entry = `[${timestamp}] ${symbol} ${message}`;
      logs.push(entry);
      
      const logsDiv = document.getElementById('logs');
      logsDiv.textContent = logs.join('\n');
      logsDiv.scrollTop = logsDiv.scrollHeight;
      
      console.log(entry);
    }
    
    function clearLogs() {
      logs.length = 0;
      document.getElementById('logs').textContent = '';
    }
    
    // Service Worker inline (pour √©viter fichier s√©par√©)
    const swCode = `
      const EVAL_API = {
        plugins: new Map(),
        
        whitelist: {
          console, Math, JSON, Date, Array, Object, String, Number, Boolean
        },
        
        createSandbox() {
          return new Proxy({}, {
            get(target, key) {
              if (key in EVAL_API.whitelist) {
                return EVAL_API.whitelist[key];
              }
              throw new Error(\`Acc√®s refus√©: "\${key}"\`);
            }
          });
        },
        
        executeCode(code) {
          try {
            const sandbox = this.createSandbox();
            const fn = new Function(...Object.keys(this.whitelist), \`"use strict"; \${code}\`);
            const result = fn.apply(sandbox, Object.values(this.whitelist));
            
            return { success: true, result };
          } catch (error) {
            return { success: false, error: error.message };
          }
        },
        
        loadPlugin(name, code) {
          try {
            const result = this.executeCode(code);
            if (!result.success) throw new Error(result.error);
            
            this.plugins.set(name, result.result);
            return { success: true, plugin: name };
          } catch (error) {
            return { success: false, error: error.message };
          }
        },
        
        callPlugin(name, method, args) {
          try {
            if (!this.plugins.has(name)) {
              throw new Error(\`Plugin "\${name}" non trouv√©\`);
            }
            
            const plugin = this.plugins.get(name);
            if (typeof plugin[method] !== 'function') {
              throw new Error(\`M√©thode "\${method}" non trouv√©e\`);
            }
            
            const result = plugin[method](...args);
            return { success: true, result };
          } catch (error) {
            return { success: false, error: error.message };
          }
        }
      };
      
      self.addEventListener('install', (event) => {
        console.log('Service Worker install√©');
        self.skipWaiting();
      });
      
      self.addEventListener('activate', (event) => {
        console.log('Service Worker activ√©');
        event.waitUntil(clients.claim());
      });
      
      self.addEventListener('fetch', (event) => {
        const url = new URL(event.request.url);
        
        // Intercepte seulement /api/*
        if (!url.pathname.startsWith('/api/')) {
          return;
        }
        
        event.respondWith(
          (async () => {
            try {
              // Health check
              if (url.pathname === '/api/health') {
                return new Response(
                  JSON.stringify({
                    status: 'ok',
                    timestamp: new Date().toISOString(),
                    plugins: Array.from(EVAL_API.plugins.keys())
                  }),
                  { headers: { 'Content-Type': 'application/json' } }
                );
              }
              
              // Parse request body
              const body = event.request.method === 'POST' 
                ? await event.request.json() 
                : {};
              
              let result;
              
              // Route: /api/eval
              if (url.pathname === '/api/eval') {
                result = EVAL_API.executeCode(body.code);
              }
              
              // Route: /api/plugin/load
              else if (url.pathname === '/api/plugin/load') {
                result = EVAL_API.loadPlugin(body.name, body.code);
              }
              
              // Route: /api/plugin/call
              else if (url.pathname === '/api/plugin/call') {
                result = EVAL_API.callPlugin(body.plugin, body.method, body.args || []);
              }
              
              else {
                result = { success: false, error: 'Endpoint non trouv√©' };
              }
              
              return new Response(
                JSON.stringify(result),
                { headers: { 'Content-Type': 'application/json' } }
              );
              
            } catch (error) {
              return new Response(
                JSON.stringify({ success: false, error: error.message }),
                { headers: { 'Content-Type': 'application/json' }, status: 500 }
              );
            }
          })()
        );
      });
    `;
    
    // Enregistrer Service Worker
    async function registerServiceWorker() {
      if (!('serviceWorker' in navigator)) {
        log('‚ùå Service Worker non support√©', 'error');
        document.getElementById('swStatus').textContent = '‚ùå Non support√©';
        document.getElementById('swStatus').className = 'status inactive';
        return false;
      }
      
      try {
        // Cr√©er blob avec le code du Service Worker
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        
        const registration = await navigator.serviceWorker.register(swUrl);
        
        log('‚úÖ Service Worker enregistr√©', 'success');
        document.getElementById('swStatus').textContent = '‚úÖ Service Worker actif';
        document.getElementById('swStatus').className = 'status active';
        
        // Attendre que le SW soit actif
        await navigator.serviceWorker.ready;
        
        log('‚úÖ Service Worker pr√™t', 'success');
        document.getElementById('apiStatus').textContent = '‚úÖ API pr√™te';
        document.getElementById('apiStatus').className = 'status active';
        
        return true;
        
      } catch (error) {
        log(`‚ùå Erreur Service Worker: ${error.message}`, 'error');
        document.getElementById('swStatus').textContent = '‚ùå Erreur';
        document.getElementById('swStatus').className = 'status inactive';
        return false;
      }
    }
    
    // Tests
    async function testEvalEndpoint() {
      try {
        const response = await fetch('/api/eval', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: 'return Math.sqrt(144);' })
        });
        
        const result = await response.json();
        log(`Test eval: ${JSON.stringify(result)}`, result.success ? 'success' : 'error');
        alert(`R√©sultat: ${JSON.stringify(result, null, 2)}`);
      } catch (error) {
        log(`Erreur test eval: ${error.message}`, 'error');
      }
    }
    
    async function testPluginLoad() {
      try {
        const response = await fetch('/api/plugin/load', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: 'MathPlugin',
            code: '({ add: (a,b) => a+b, multiply: (a,b) => a*b })'
          })
        });
        
        const result = await response.json();
        log(`Plugin charg√©: ${JSON.stringify(result)}`, result.success ? 'success' : 'error');
        alert(`R√©sultat: ${JSON.stringify(result, null, 2)}`);
      } catch (error) {
        log(`Erreur chargement plugin: ${error.message}`, 'error');
      }
    }
    
    async function testPluginCall() {
      try {
        // Charge d'abord le plugin
        await fetch('/api/plugin/load', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: 'MathPlugin',
            code: '({ add: (a,b) => a+b, multiply: (a,b) => a*b })'
          })
        });
        
        // Appelle le plugin
        const response = await fetch('/api/plugin/call', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            plugin: 'MathPlugin',
            method: 'multiply',
            args: [7, 6]
          })
        });
        
        const result = await response.json();
        log(`Plugin appel√©: ${JSON.stringify(result)}`, result.success ? 'success' : 'error');
        alert(`R√©sultat: ${JSON.stringify(result, null, 2)}`);
      } catch (error) {
        log(`Erreur appel plugin: ${error.message}`, 'error');
      }
    }
    
    async function testHealth() {
      try {
        const response = await fetch('/api/health');
        const result = await response.json();
        log(`Health check: ${JSON.stringify(result)}`, 'success');
        alert(`R√©sultat: ${JSON.stringify(result, null, 2)}`);
      } catch (error) {
        log(`Erreur health check: ${error.message}`, 'error');
      }
    }
    
    function copyPythonCode() {
      const code = document.getElementById('pythonCode').textContent;
      navigator.clipboard.writeText(code);
      alert('‚úÖ Code Python copi√©!\n\nCollez-le dans Google Colab et remplacez l\'URL.');
    }
    
    // Initialisation
    window.addEventListener('load', async () => {
      log('üöÄ Initialisation...', 'info');
      const success = await registerServiceWorker();
      
      if (success) {
        log('‚úÖ Syst√®me pr√™t! Vous pouvez maintenant tester les endpoints.', 'success');
        
        // Mettre √† jour le code Python avec l'URL actuelle
        const currentUrl = window.location.origin;
        const pythonCode = document.getElementById('pythonCode');
        pythonCode.textContent = pythonCode.textContent.replace(
          'https://VOTRE-APP.onrender.com',
          currentUrl
        );
      } else {
        log('‚ùå Impossible d\'initialiser le syst√®me', 'error');
      }
    });
  </script>
</body>
</html>