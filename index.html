<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CodeEnhancer Studio - Beta</title>
  <style>
    /* ═══════════════════════════════════════════════════════════════
       🎨 MODULE FRONTEND - STYLES
       ═══════════════════════════════════════════════════════════════ */
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      color: #1f2937;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background: white;
      padding: 20px 40px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h1 {
      font-size: 2em;
      color: #667eea;
    }
    
    .user-info {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    
    .hero {
      background: white;
      padding: 60px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      margin-bottom: 40px;
    }
    
    .hero h2 {
      font-size: 2.5em;
      margin-bottom: 20px;
      color: #1f2937;
    }
    
    .hero p {
      font-size: 1.2em;
      color: #6b7280;
      margin-bottom: 30px;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 1.1em;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s;
      font-weight: bold;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    
    .feature-card {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .feature-card h3 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .dashboard {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    
    .actions {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    .projects-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .project-card {
      background: #f9fafb;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .project-card:hover {
      border-color: #667eea;
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    footer {
      background: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      margin-top: 40px;
      color: #6b7280;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1em;
      margin-bottom: 15px;
      font-family: inherit;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    textarea {
      min-height: 150px;
      resize: vertical;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #374151;
    }
    
    .warning {
      background: #fef2f2;
      border: 2px solid #fca5a5;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      color: #7f1d1d;
    }
    
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
    }
    
    .spinner {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    pre {
      background: #1f2937;
      color: #f9fafb;
      padding: 20px;
      border-radius: 10px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    /**
     * ═══════════════════════════════════════════════════════════════
     * 🌌 NEXUS AXION 2.0 - CodeEnhancer Studio
     * ═══════════════════════════════════════════════════════════════
     * 
     * Architecture Tri-Modulaire dans UN SEUL FICHIER
     * - Module 1: Frontend (UI + Routing)
     * - Module 2: Backend (Logic + IR)
     * - Module 3: Connecteur (Cache + Storage)
     */

    // ═══════════════════════════════════════════════════════════════
    // 🔌 MODULE 3: CONNECTEUR (Storage + Cache + Sessions)
    // ═══════════════════════════════════════════════════════════════

    const ConnectorModule = {
      name: 'ConnectorModule',
      
      // In-Memory Storage (LocalStorage backup)
      storage: {
        sessions: new Map(),
        projects: new Map(),
        userStats: new Map(),
        
        init() {
          // Load from localStorage
          const saved = localStorage.getItem('codeenhancer_data');
          if (saved) {
            try {
              const data = JSON.parse(saved);
              if (data.projects) {
                data.projects.forEach(p => this.projects.set(p.id, p));
              }
            } catch (e) {
              console.error('Failed to load saved data');
            }
          }
        },
        
        save() {
          // Save to localStorage
          const data = {
            projects: Array.from(this.projects.values())
          };
          localStorage.setItem('codeenhancer_data', JSON.stringify(data));
        }
      },
      
      // Cache
      cache: {
        L1: new Map(),
        
        get(key) {
          const entry = this.L1.get(key);
          if (!entry) return null;
          if (Date.now() - entry.createdAt > 60000) {
            this.L1.delete(key);
            return null;
          }
          return entry.value;
        },
        
        set(key, value) {
          this.L1.set(key, { value, createdAt: Date.now() });
        }
      },
      
      init() {
        this.storage.init();
        console.log('✅ Connecteur initialisé');
      }
    };

    // ═══════════════════════════════════════════════════════════════
    // ⚙️ MODULE 2: BACKEND (Logic + Security + IR)
    // ═══════════════════════════════════════════════════════════════

    const BackendModule = {
      name: 'BackendModule',
      
      // Modules métier
      modules: {
        ids: {
          generateFreeID() {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substring(2, 8);
            return `FREE-${timestamp}-${random}`;
          },
          
          validate(id) {
            if (!id) return { valid: false, tier: 'none' };
            if (id.startsWith('FREE-')) {
              return {
                valid: true,
                tier: 'beta',
                limits: { projects_per_month: 5 }
              };
            }
            return { valid: false, tier: 'none' };
          }
        },
        
        projects: {
          create(userId, name, description) {
            const projectId = `proj_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`;
            
            const project = {
              id: projectId,
              userId,
              name,
              description,
              files: {},
              createdAt: Date.now(),
              status: 'active'
            };
            
            ConnectorModule.storage.projects.set(projectId, project);
            ConnectorModule.storage.save();
            
            return project;
          },
          
          list(userId) {
            const projects = [];
            for (const [id, project] of ConnectorModule.storage.projects) {
              if (project.userId === userId) {
                projects.push(project);
              }
            }
            return projects.sort((a, b) => b.createdAt - a.createdAt);
          },
          
          get(projectId) {
            return ConnectorModule.storage.projects.get(projectId);
          },
          
          update(projectId, files) {
            const project = ConnectorModule.storage.projects.get(projectId);
            if (project) {
              project.files = files;
              ConnectorModule.storage.projects.set(projectId, project);
              ConnectorModule.storage.save();
            }
          },
          
          countUserProjects(userId) {
            const startOfMonth = new Date();
            startOfMonth.setDate(1);
            startOfMonth.setHours(0, 0, 0, 0);
            
            let count = 0;
            for (const [id, project] of ConnectorModule.storage.projects) {
              if (project.userId === userId && project.createdAt >= startOfMonth.getTime()) {
                count++;
              }
            }
            return count;
          }
        },
        
        ai: {
          async generateWithIR(projectDesc, aiProvider, apiKey) {
            // Simulate AI generation for demo
            // In production, call real AI API
            
            return new Promise((resolve) => {
              setTimeout(() => {
                const files = {
                  'src/main.py': `# ${projectDesc}\n\ndef main():\n    print("Hello World")\n\nif __name__ == "__main__":\n    main()`,
                  'README.md': `# Project\n\n${projectDesc}`,
                  'requirements.txt': 'flask==3.0.0'
                };
                
                resolve({
                  success: true,
                  files,
                  irState: { score: 85 }
                });
              }, 2000);
            });
          }
        }
      }
    };

    // ═══════════════════════════════════════════════════════════════
    // 📦 MODULE 1: FRONTEND (UI + Routing + Pages)
    // ═══════════════════════════════════════════════════════════════

    const FrontendModule = {
      name: 'FrontendModule',
      
      // Router
      router: {
        currentPage: 'landing',
        
        navigate(page) {
          this.currentPage = page;
          FrontendModule.render();
        }
      },
      
      // State
      store: {
        userId: null,
        userTier: null,
        aiConfig: null,
        currentProject: null
      },
      
      // Pages
      pages: {
        landing() {
          return `
            <div class="container">
              <div class="hero">
                <h2>⚡ CodeEnhancer Studio</h2>
                <p>L'IA qui code comme un développeur professionnel sous tes yeux</p>
                <p style="color: #10b981; font-weight: bold;">🎉 Accès Beta Gratuit - 5 projets/mois</p>
                <button onclick="NexusAxion.handleStartBeta()">🚀 Commencer Maintenant</button>
              </div>
              
              <div class="warning">
                <h3>⚠️ Version Beta</h3>
                <p><strong>Important:</strong> Les projets sont sauvegardés localement (LocalStorage). 
                Pensez à <strong>télécharger en ZIP</strong> pour backup permanent !</p>
              </div>
              
              <div class="features">
                <div class="feature-card">
                  <h3>✨ Live Coding Immersif</h3>
                  <p>Voir l'IA coder en temps réel avec la technologie IR brevetée</p>
                </div>
                <div class="feature-card">
                  <h3>📁 Organisation Pro</h3>
                  <p>Structure multi-fichiers professionnelle automatique</p>
                </div>
                <div class="feature-card">
                  <h3>🔱 GitHub Push</h3>
                  <p>Push automatique vers ton repo (bientôt)</p>
                </div>
                <div class="feature-card">
                  <h3>✏️ Édition Visuelle</h3>
                  <p>Modifier le code généré directement</p>
                </div>
              </div>
              
              <footer>
                <p><strong>Powered by Nexus Studio</strong></p>
                <p>📧 Contact: nexusstudio100@gmail.com</p>
                <p style="margin-top: 15px; color: #10b981;">
                  🎁 <strong>Inscription anticipée = 3 mois Pro gratuits</strong><br>
                  Contactez-nous pour réserver votre place !
                </p>
              </footer>
            </div>
          `;
        },
        
        dashboard() {
          const userId = FrontendModule.store.userId;
          const projects = BackendModule.modules.projects.list(userId);
          const projectsUsed = BackendModule.modules.projects.countUserProjects(userId);
          
          return `
            <div class="container">
              <header>
                <h1>⚡ CodeEnhancer Studio</h1>
                <div class="user-info">
                  <span>ID: <strong>${userId.substring(0, 15)}...</strong></span>
                  <span>Projets: <strong>${projectsUsed}/5</strong></span>
                  <span style="color: #10b981;">✅ Beta</span>
                </div>
              </header>
              
              <div class="dashboard">
                <div class="actions">
                  <button onclick="NexusAxion.showModal('newProject')">➕ Nouveau Projet</button>
                  <button onclick="NexusAxion.showModal('configAI')">🔧 Configurer IA</button>
                </div>
                
                <h2>Mes Projets</h2>
                <div class="projects-grid">
                  ${projects.length > 0 ? projects.map(p => `
                    <div class="project-card" onclick="NexusAxion.openProject('${p.id}')">
                      <h3>📁 ${p.name}</h3>
                      <p>${new Date(p.createdAt).toLocaleDateString()}</p>
                      <p style="color: #10b981;">✅ ${p.status}</p>
                    </div>
                  `).join('') : '<p style="color: #6b7280;">Aucun projet. Créez-en un !</p>'}
                </div>
              </div>
            </div>
            
            ${FrontendModule.components.modal('newProject', `
              <h2>➕ Nouveau Projet</h2>
              <form onsubmit="NexusAxion.handleCreateProject(event)">
                <label>Nom du projet</label>
                <input type="text" id="projectName" required placeholder="Ex: API Todo">
                
                <label>Description complète</label>
                <textarea id="projectDesc" required placeholder="Décris ton projet..."></textarea>
                
                <button type="submit">🚀 Générer</button>
                <button type="button" onclick="NexusAxion.closeModal('newProject')" style="background: #6b7280; margin-left: 10px;">Annuler</button>
              </form>
            `)}
            
            ${FrontendModule.components.modal('configAI', `
              <h2>🔧 Configurer IA</h2>
              <form onsubmit="NexusAxion.handleSaveAIConfig(event)">
                <label>Provider IA</label>
                <select id="aiProvider">
                  <option value="groq">Groq (Llama 4 - Gratuit)</option>
                  <option value="demo">Demo (Simulation)</option>
                </select>
                
                <label>API Key (optionnel pour demo)</label>
                <input type="password" id="aiApiKey" placeholder="Votre clé API">
                
                <button type="submit">💾 Sauvegarder</button>
                <button type="button" onclick="NexusAxion.closeModal('configAI')" style="background: #6b7280; margin-left: 10px;">Annuler</button>
              </form>
            `)}
          `;
        },
        
        liveCoding() {
          const project = FrontendModule.store.currentProject;
          
          return `
            <div class="container">
              <header>
                <h1>⚡ ${project ? project.name : 'Projet'}</h1>
                <button onclick="NexusAxion.backToDashboard()">🏠 Dashboard</button>
              </header>
              
              <div class="dashboard">
                <div id="generationStatus" class="loading">
                  <div class="spinner"></div>
                  <p>L'IA code votre projet...</p>
                </div>
                
                <div id="projectResult" style="display: none;">
                  <h3>✅ Projet généré !</h3>
                  <div id="filesList"></div>
                  <div class="actions">
                    <button onclick="NexusAxion.downloadProject()">⬇️ Télécharger ZIP</button>
                  </div>
                </div>
              </div>
            </div>
          `;
        }
      },
      
      // Components
      components: {
        modal(id, content) {
          return `
            <div id="modal-${id}" class="modal">
              <div class="modal-content">
                ${content}
              </div>
            </div>
          `;
        }
      },
      
      // Render
      render() {
        const page = this.pages[this.router.currentPage];
        if (page) {
          document.getElementById('app').innerHTML = page();
        }
      }
    };

    // ═══════════════════════════════════════════════════════════════
    // 🌟 NEXUS AXION - Système Unifié
    // ═══════════════════════════════════════════════════════════════

    const NexusAxion = {
      frontend: FrontendModule,
      backend: BackendModule,
      connector: ConnectorModule,
      
      async init() {
        // Init connector
        this.connector.init();
        
        // Check if user already has ID
        const savedUserId = localStorage.getItem('userId');
        if (savedUserId) {
          this.frontend.store.userId = savedUserId;
          this.frontend.router.navigate('dashboard');
        } else {
          this.frontend.router.navigate('landing');
        }
      },
      
      // Handlers
      handleStartBeta() {
        const userId = this.backend.modules.ids.generateFreeID();
        localStorage.setItem('userId', userId);
        this.frontend.store.userId = userId;
        this.frontend.router.navigate('dashboard');
      },
      
      showModal(modalId) {
        const modal = document.getElementById(`modal-${modalId}`);
        if (modal) modal.classList.add('active');
      },
      
      closeModal(modalId) {
        const modal = document.getElementById(`modal-${modalId}`);
        if (modal) modal.classList.remove('active');
      },
      
      async handleCreateProject(e) {
        e.preventDefault();
        
        const name = document.getElementById('projectName').value;
        const desc = document.getElementById('projectDesc').value;
        
        // Check AI config
        const aiConfig = localStorage.getItem('aiConfig');
        if (!aiConfig) {
          alert('Veuillez configurer votre IA d\'abord');
          this.closeModal('newProject');
          this.showModal('configAI');
          return;
        }
        
        // Check project limit
        const projectsUsed = this.backend.modules.projects.countUserProjects(this.frontend.store.userId);
        if (projectsUsed >= 5) {
          alert('Limite de 5 projets/mois atteinte !');
          return;
        }
        
        this.closeModal('newProject');
        
        // Create project
        const project = this.backend.modules.projects.create(
          this.frontend.store.userId,
          name,
          desc
        );
        
        this.frontend.store.currentProject = project;
        this.frontend.router.navigate('liveCoding');
        
        // Generate code
        const config = JSON.parse(aiConfig);
        const result = await this.backend.modules.ai.generateWithIR(
          desc,
          config.provider,
          config.apiKey
        );
        
        if (result.success) {
          // Update project
          this.backend.modules.projects.update(project.id, result.files);
          project.files = result.files;
          
          // Display result
          document.getElementById('generationStatus').style.display = 'none';
          const resultDiv = document.getElementById('projectResult');
          resultDiv.style.display = 'block';
          
          const filesHtml = Object.entries(result.files).map(([name, content]) => `
            <details style="margin: 15px 0;">
              <summary style="cursor: pointer; font-weight: bold; padding: 10px; background: #f9fafb; border-radius: 5px;">
                📄 ${name}
              </summary>
              <pre>${content}</pre>
            </details>
          `).join('');
          
          document.getElementById('filesList').innerHTML = filesHtml;
        }
      },
      
      handleSaveAIConfig(e) {
        e.preventDefault();
        
        const provider = document.getElementById('aiProvider').value;
        const apiKey = document.getElementById('aiApiKey').value;
        
        const config = { provider, apiKey };
        localStorage.setItem('aiConfig', JSON.stringify(config));
        
        this.closeModal('configAI');
        alert('✅ Configuration IA sauvegardée !');
      },
      
      openProject(projectId) {
        const project = this.backend.modules.projects.get(projectId);
        if (project) {
          this.frontend.store.currentProject = project;
          this.frontend.router.navigate('liveCoding');
          
          // Display files
          setTimeout(() => {
            document.getElementById('generationStatus').style.display = 'none';
            const resultDiv = document.getElementById('projectResult');
            resultDiv.style.display = 'block';
            
            const filesHtml = Object.entries(project.files).map(([name, content]) => `
              <details style="margin: 15px 0;">
                <summary style="cursor: pointer; font-weight: bold; padding: 10px; background: #f9fafb; border-radius: 5px;">
                  📄 ${name}
                </summary>
                <pre>${content}</pre>
              </details>
            `).join('');
            
            document.getElementById('filesList').innerHTML = filesHtml;
          }, 100);
        }
      },
      
      backToDashboard() {
        this.frontend.router.navigate('dashboard');
      },
      
      downloadProject() {
        alert('Téléchargement ZIP en développement. Pour l\'instant, copiez/collez le code manuellement.');
      }
    };

    // ═══════════════════════════════════════════════════════════════
    // 🚀 STARTUP
    // ═══════════════════════════════════════════════════════════════

    window.addEventListener('DOMContentLoaded', () => {
      console.log('🚀 CodeEnhancer Studio - Nexus Axion 2.0');
      NexusAxion.init();
    });
  </script>
</body>
</html>