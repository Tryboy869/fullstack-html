<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test IR - Informatique R√©alitaire</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #0a0e27;
            color: #e4e7eb;
            padding: 2rem;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 {
            text-align: center;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .panel {
            background: #151932;
            border: 1px solid #1f2937;
            border-radius: 8px;
            padding: 1.5rem;
        }
        h2 {
            color: #3b82f6;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover { background: #2563eb; }
        button:active { transform: scale(0.98); }
        .console {
            background: #000;
            border: 1px solid #1f2937;
            border-radius: 8px;
            padding: 1rem;
            height: 400px;
            overflow-y: auto;
            font-size: 0.85rem;
            line-height: 1.6;
            margin-top: 1rem;
        }
        .log { margin-bottom: 0.5rem; }
        .log-time { color: #6b7280; }
        .log-success { color: #10b981; }
        .log-info { color: #3b82f6; }
        .log-warning { color: #f59e0b; }
        .log-error { color: #ef4444; }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        .stat-card {
            background: rgba(59, 130, 246, 0.1);
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #10b981;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-top: 0.25rem;
        }
        iframe {
            width: 100%;
            height: 500px;
            border: 1px solid #1f2937;
            border-radius: 8px;
            background: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Informatique R√©alitaire - Client Demo</h1>
        
        <div class="grid">
            <div class="panel">
                <h2>üéÆ Actions de Test</h2>
                
                <button onclick="testInsert()">‚ûï INSERT User</button>
                <button onclick="testSelect()">üìä SELECT Users</button>
                <button onclick="testUpdate()">‚úèÔ∏è UPDATE User</button>
                <button onclick="testDelete()">üóëÔ∏è DELETE User</button>
                <br>
                <button onclick="testBatch()">üöÄ Batch Test (10 users)</button>
                <button onclick="clearLogs()">üßπ Clear Logs</button>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="insert-count">0</div>
                        <div class="stat-label">Inserts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="select-count">0</div>
                        <div class="stat-label">Selects</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-users">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h2>üìä Statistiques Client</h2>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="requests-sent">0</div>
                        <div class="stat-label">Requests Sent</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="responses-received">0</div>
                        <div class="stat-label">Responses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avg-latency">0ms</div>
                        <div class="stat-label">Avg Latency</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <h2>üìù Client Logs (Ce que le client voit)</h2>
            <div class="console" id="client-console"></div>
        </div>
        
        <div class="panel">
            <h2>üóÑÔ∏è Serveur IR (Ce que le serveur per√ßoit)</h2>
            <iframe id="server-iframe" src="https://fullstack-html-alpha.vercel.app"></iframe>
        </div>
    </div>

    <script>
        // =================================================================
        // CLIENT IR - CONSOMMATEUR DE LA DB
        // =================================================================
        
        let stats = {
            insertCount: 0,
            selectCount: 0,
            totalUsers: 0,
            requestsSent: 0,
            responsesReceived: 0,
            latencies: []
        };
        
        let lastUserId = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const console = document.getElementById('client-console');
            
            const logEntry = document.createElement('div');
            logEntry.className = `log log-${type}`;
            logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span> ${message}`;
            
            console.insertBefore(logEntry, console.firstChild);
            
            // Garder seulement les 50 derniers logs
            while (console.children.length > 50) {
                console.removeChild(console.lastChild);
            }
        }
        
        function updateStats() {
            document.getElementById('insert-count').textContent = stats.insertCount;
            document.getElementById('select-count').textContent = stats.selectCount;
            document.getElementById('total-users').textContent = stats.totalUsers;
            document.getElementById('requests-sent').textContent = stats.requestsSent;
            document.getElementById('responses-received').textContent = stats.responsesReceived;
            
            if (stats.latencies.length > 0) {
                const avg = stats.latencies.reduce((a, b) => a + b, 0) / stats.latencies.length;
                document.getElementById('avg-latency').textContent = `${avg.toFixed(0)}ms`;
            }
        }
        
        async function dbQuery(method, collection, data = null, id = null) {
            return new Promise((resolve, reject) => {
                const requestId = Date.now() + Math.random();
                const startTime = performance.now();
                
                stats.requestsSent++;
                updateStats();
                
                log(`üì§ Sending ${method} request to /api/${collection}${id ? '/' + id : ''}`, 'info');
                
                function handleResponse(event) {
                    if (event.data.type === 'DB_RESPONSE' && 
                        event.data.requestId === requestId) {
                        window.removeEventListener('message', handleResponse);
                        
                        const latency = performance.now() - startTime;
                        stats.latencies.push(latency);
                        stats.responsesReceived++;
                        updateStats();
                        
                        if (event.data.success) {
                            log(`‚úÖ Response received (${latency.toFixed(0)}ms)`, 'success');
                            resolve(event.data.data);
                        } else {
                            log(`‚ùå Error: ${event.data.error}`, 'error');
                            reject(new Error(event.data.error));
                        }
                    }
                }
                
                window.addEventListener('message', handleResponse);
                
                const iframe = document.getElementById('server-iframe');
                const path = id ? `/api/${collection}/${id}` : `/api/${collection}`;
                
                iframe.contentWindow.postMessage({
                    type: 'DB_REQUEST',
                    method,
                    path,
                    body: data,
                    requestId
                }, '*');
                
                setTimeout(() => {
                    window.removeEventListener('message', handleResponse);
                    log(`‚è±Ô∏è Request timeout`, 'warning');
                    reject(new Error('Timeout'));
                }, 10000);
            });
        }
        
        // =================================================================
        // ACTIONS DE TEST
        // =================================================================
        
        async function testInsert() {
            try {
                const user = {
                    name: `User ${Date.now() % 1000}`,
                    email: `user${Date.now() % 1000}@example.com`,
                    role: 'user',
                    created_at: new Date().toISOString()
                };
                
                log(`‚ûï Inserting user: ${user.name}`, 'info');
                const result = await dbQuery('POST', 'users', user);
                
                lastUserId = result.id;
                stats.insertCount++;
                stats.totalUsers++;
                updateStats();
                
                log(`‚úÖ User inserted with ID: ${result.id}`, 'success');
            } catch (error) {
                log(`‚ùå Insert failed: ${error.message}`, 'error');
            }
        }
        
        async function testSelect() {
            try {
                log(`üìä Selecting all users...`, 'info');
                const users = await dbQuery('GET', 'users');
                
                stats.selectCount++;
                stats.totalUsers = users.length;
                updateStats();
                
                log(`‚úÖ Found ${users.length} users:`, 'success');
                users.slice(0, 5).forEach(user => {
                    const data = user.data || user;
                    log(`   - ${data.name} (${data.email})`, 'info');
                });
                
                if (users.length > 5) {
                    log(`   ... and ${users.length - 5} more`, 'info');
                }
            } catch (error) {
                log(`‚ùå Select failed: ${error.message}`, 'error');
            }
        }
        
        async function testUpdate() {
            if (!lastUserId) {
                log(`‚ö†Ô∏è No user to update. Insert a user first.`, 'warning');
                return;
            }
            
            try {
                const updates = {
                    role: 'admin',
                    updated_at: new Date().toISOString()
                };
                
                log(`‚úèÔ∏è Updating user ${lastUserId}...`, 'info');
                await dbQuery('PUT', 'users', updates, lastUserId);
                
                log(`‚úÖ User ${lastUserId} updated to admin`, 'success');
            } catch (error) {
                log(`‚ùå Update failed: ${error.message}`, 'error');
            }
        }
        
        async function testDelete() {
            if (!lastUserId) {
                log(`‚ö†Ô∏è No user to delete. Insert a user first.`, 'warning');
                return;
            }
            
            try {
                log(`üóëÔ∏è Deleting user ${lastUserId}...`, 'info');
                await dbQuery('DELETE', 'users', null, lastUserId);
                
                stats.totalUsers--;
                updateStats();
                
                log(`‚úÖ User ${lastUserId} deleted`, 'success');
                lastUserId = null;
            } catch (error) {
                log(`‚ùå Delete failed: ${error.message}`, 'error');
            }
        }
        
        async function testBatch() {
            log(`üöÄ Starting batch test (10 users)...`, 'info');
            
            for (let i = 0; i < 10; i++) {
                await testInsert();
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            log(`‚úÖ Batch test completed`, 'success');
            await testSelect();
        }
        
        function clearLogs() {
            document.getElementById('client-console').innerHTML = '';
            log(`üßπ Logs cleared`, 'info');
        }
        
        // =================================================================
        // INITIALISATION
        // =================================================================
        
        log(`üöÄ Client IR initialized`, 'success');
        log(`üîó Connected to server: https://fullstack-html-alpha.vercel.app`, 'info');
        log(`üì° Ready to send queries to PostgreSQL (IR Framework)`, 'info');
        
        // Auto-test au chargement
        setTimeout(() => {
            log(`üéØ Running initial test...`, 'info');
            testInsert().then(() => testSelect());
        }, 2000);
    </script>
</body>
</html>
