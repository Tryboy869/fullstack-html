<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic P2P - Phase Mesh Autonome</title>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background: #020617; 
            color: #2dd4bf; 
            font-family: 'ui-monospace', 'SFMono-Regular', monospace; 
        }
        .cosmic-card { 
            border: 1px solid #134e4a; 
            background: rgba(0,0,0,0.8); 
            box-shadow: 0 0 20px rgba(45, 212, 191, 0.1); 
        }
        .status-pulse { 
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; 
        }
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: .3; } 
        }
        .message-bubble {
            max-width: 70%;
            word-wrap: break-word;
        }
        .message-sent {
            background: linear-gradient(135deg, #134e4a 0%, #0f766e 100%);
            margin-left: auto;
        }
        .message-received {
            background: rgba(45, 212, 191, 0.1);
            border: 1px solid #134e4a;
        }
        .peer-online {
            border-left: 3px solid #10b981;
        }
        .peer-offline {
            border-left: 3px solid #6b7280;
            opacity: 0.5;
        }
    </style>
</head>
<body class="p-4 min-h-screen flex flex-col items-center">
    <div class="w-full max-w-7xl">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-emerald-500">
                COSMIC P2P MESH
            </h1>
            <p class="text-teal-900 text-sm mt-2 uppercase tracking-widest">Réseau Intranet Décentralisé - Backend Distribué</p>
        </header>

        <!-- Status Bar -->
        <div class="cosmic-card rounded-2xl p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <div id="status-indicator" class="w-3 h-3 rounded-full bg-red-500"></div>
                        <span id="status-text" class="text-xs font-bold uppercase">Déconnecté</span>
                    </div>
                    <div class="flex items-center gap-2 text-xs">
                        <i data-lucide="users" class="w-4 h-4"></i>
                        <span id="peer-count">0</span>
                        <span class="text-teal-900">peers</span>
                    </div>
                    <div class="flex items-center gap-2 text-xs">
                        <i data-lucide="database" class="w-4 h-4"></i>
                        <span id="cache-size">0 KB</span>
                    </div>
                    <div class="flex items-center gap-2 text-xs">
                        <i data-lucide="activity" class="w-4 h-4"></i>
                        <span id="mesh-latency">-- ms</span>
                    </div>
                </div>
                <div id="offline-badge" class="hidden flex items-center gap-2 px-3 py-1 bg-teal-950/30 rounded-full">
                    <i data-lucide="wifi-off" class="w-4 h-4 text-teal-500"></i>
                    <span class="text-xs font-bold text-teal-500">MODE OFFLINE</span>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Sidebar: Control + Peers -->
            <div class="space-y-6">
                <!-- Activation -->
                <div class="cosmic-card p-6 rounded-2xl border-teal-500/30">
                    <h2 class="text-xs font-bold mb-4 text-teal-500 uppercase flex items-center gap-2">
                        <i data-lucide="shield-check" class="w-4 h-4"></i>
                        Activation Nœud
                    </h2>
                    <input 
                        id="phone" 
                        type="text" 
                        placeholder="+33 6..." 
                        class="w-full p-3 bg-black/50 border border-teal-900 rounded-xl mb-3 focus:outline-none focus:border-teal-400 transition-all"
                    >
                    <button 
                        onclick="activateNode()" 
                        id="btn-activate" 
                        class="w-full bg-teal-600 hover:bg-teal-500 text-black font-bold p-3 rounded-xl transition-all active:scale-95 flex items-center justify-center gap-2"
                    >
                        <i data-lucide="power" class="w-4 h-4"></i>
                        ACTIVER MESH
                    </button>
                    <div id="node-info" class="hidden mt-4 p-3 bg-teal-950/30 rounded-lg border border-teal-900/50">
                        <p class="text-[10px] text-teal-600 uppercase mb-1">Hash Mesh (Identité)</p>
                        <p id="display-id" class="text-xs break-all font-bold text-teal-300"></p>
                    </div>
                </div>

                <!-- Peers List -->
                <div class="cosmic-card p-6 rounded-2xl border-teal-500/30">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xs font-bold text-teal-500 uppercase flex items-center gap-2">
                            <i data-lucide="radio" class="w-4 h-4"></i>
                            Peers Actifs
                        </h2>
                        <button 
                            onclick="discoverPeers()" 
                            id="btn-discover"
                            class="p-2 bg-teal-950/50 hover:bg-teal-900/50 rounded-lg transition-all disabled:opacity-30"
                            disabled
                        >
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div id="peers-list" class="space-y-2 max-h-96 overflow-y-auto">
                        <div class="text-xs text-teal-700 text-center py-8 flex flex-col items-center gap-2">
                            <i data-lucide="satellite" class="w-8 h-8 opacity-30"></i>
                            <span>Aucun peer détecté</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main: Chat Community -->
            <div class="lg:col-span-2 cosmic-card rounded-2xl overflow-hidden">
                <!-- Chat Header -->
                <div class="border-b border-teal-900/50 p-4 bg-black/30">
                    <h2 class="text-sm font-bold text-teal-500 uppercase flex items-center gap-2">
                        <i data-lucide="messages-square" class="w-5 h-5"></i>
                        Communauté Mesh Intranet
                    </h2>
                    <p class="text-xs text-teal-900 mt-1">Communication décentralisée peer-to-peer</p>
                </div>

                <!-- Messages Area -->
                <div id="messages-area" class="h-[500px] overflow-y-auto p-6 space-y-4">
                    <div class="text-center text-xs text-teal-700 py-12 flex flex-col items-center gap-3">
                        <i data-lucide="message-circle" class="w-12 h-12 opacity-20"></i>
                        <p>Activez votre nœud mesh pour rejoindre la communauté</p>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="border-t border-teal-900/50 p-4 bg-black/30">
                    <div class="flex gap-3">
                        <input 
                            id="message-input" 
                            type="text" 
                            placeholder="Message à la communauté mesh..." 
                            class="flex-1 p-3 bg-black/50 border border-teal-900 rounded-xl focus:outline-none focus:border-teal-400 transition-all disabled:opacity-50"
                            disabled
                        >
                        <button 
                            onclick="sendMessage()" 
                            id="btn-send"
                            class="px-6 bg-teal-600 hover:bg-teal-500 text-black font-bold rounded-xl transition-all active:scale-95 disabled:opacity-30 flex items-center gap-2"
                            disabled
                        >
                            <i data-lucide="send" class="w-4 h-4"></i>
                            Envoyer
                        </button>
                    </div>
                    <div class="flex items-center gap-4 mt-3 text-xs text-teal-900">
                        <div class="flex items-center gap-2">
                            <i data-lucide="lock" class="w-3 h-3"></i>
                            <span>Chiffré E2E</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i data-lucide="hard-drive" class="w-3 h-3"></i>
                            <span>Stockage local</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i data-lucide="share-2" class="w-3 h-3"></i>
                            <span>Propagation P2P</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Logs -->
        <div class="cosmic-card rounded-2xl p-6 mt-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xs font-bold text-teal-500 uppercase flex items-center gap-2">
                    <i data-lucide="terminal" class="w-4 h-4"></i>
                    Logs Système
                </h2>
                <button onclick="clearLogs()" class="text-xs text-teal-700 hover:text-teal-500">
                    Effacer
                </button>
            </div>
            <div id="logs" class="h-32 overflow-y-auto text-[10px] leading-relaxed font-mono text-teal-700"></div>
        </div>
    </div>

    <script>
        // =============================================================================
        // COSMIC MESH - Service Worker + IndexedDB + Community
        // =============================================================================

        let myNodeId = null;
        let meshDB = null;
        let activePeers = new Map();
        let serviceWorkerReady = false;

        // Initialize Lucide icons
        lucide.createIcons();

        // =============================================================================
        // 1. SERVICE WORKER
        // =============================================================================

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('cosmic-worker.js')
                .then(registration => {
                    addLog('Service Worker enregistré - Backend distribué actif', 'success');
                    serviceWorkerReady = true;
                    updateStatus('online', 'Service Worker Actif');
                    navigator.serviceWorker.addEventListener('message', handleWorkerMessage);
                })
                .catch(err => {
                    addLog(`Erreur Service Worker: ${err.message}`, 'error');
                });
        }

        function handleWorkerMessage(event) {
            const { type, data } = event.data;
            
            switch(type) {
                case 'PEER_DISCOVERED':
                    addPeerToList(data.peerId, data.method);
                    break;
                case 'MESSAGE_RECEIVED':
                    displayMessage(data.message, false);
                    break;
                case 'SYNC_UPDATE':
                    addLog(`Synchronisation: ${data.count} messages`, 'info');
                    break;
            }
        }

        // =============================================================================
        // 2. INDEXEDDB
        // =============================================================================

        async function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('CosmicMeshDB', 1);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    meshDB = request.result;
                    addLog('IndexedDB initialisé - Stockage persistant OK', 'success');
                    resolve(meshDB);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    if (!db.objectStoreNames.contains('peers')) {
                        const peerStore = db.createObjectStore('peers', { keyPath: 'id' });
                        peerStore.createIndex('lastSeen', 'lastSeen', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('messages')) {
                        const msgStore = db.createObjectStore('messages', { keyPath: 'id', autoIncrement: true });
                        msgStore.createIndex('from', 'from', { unique: false });
                        msgStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('keys')) {
                        db.createObjectStore('keys', { keyPath: 'nodeId' });
                    }
                };
            });
        }

        async function dbSave(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = meshDB.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function dbGetAll(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = meshDB.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // =============================================================================
        // 3. IDENTITY
        // =============================================================================

        async function hashPhone(phone) {
            const normalized = phone.replace(/\s+/g, '').replace(/[-.()]/g, '');
            const msgUint8 = new TextEncoder().encode(normalized);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            return Array.from(new Uint8Array(hashBuffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        async function generateCryptoKeys(nodeId) {
            addLog('Génération clés cryptographiques RSA-2048...', 'info');
            
            const keyPair = await crypto.subtle.generateKey(
                {
                    name: "RSA-OAEP",
                    modulusLength: 2048,
                    publicExponent: new Uint8Array([1, 0, 1]),
                    hash: "SHA-256"
                },
                true,
                ["encrypt", "decrypt"]
            );

            const publicKeyExported = await crypto.subtle.exportKey('jwk', keyPair.publicKey);
            
            await dbSave('keys', {
                nodeId: nodeId,
                publicKey: publicKeyExported,
                privateKey: keyPair.privateKey,
                createdAt: Date.now()
            });

            addLog('Clés générées et stockées localement', 'success');
            return { publicKey: publicKeyExported, privateKey: keyPair.privateKey };
        }

        // =============================================================================
        // 4. NODE ACTIVATION
        // =============================================================================

        async function activateNode() {
            const phone = document.getElementById('phone').value;
            if (!phone) {
                alert('Entrez votre numéro de téléphone');
                return;
            }

            addLog('Activation du nœud mesh...', 'info');
            
            myNodeId = await hashPhone(phone);
            addLog(`Node ID: ${myNodeId.substring(0, 16)}...`, 'info');

            document.getElementById('node-info').classList.remove('hidden');
            document.getElementById('display-id').textContent = myNodeId;

            const keys = await generateCryptoKeys(myNodeId);

            await dbSave('peers', {
                id: myNodeId,
                phone: phone,
                publicKey: keys.publicKey,
                lastSeen: Date.now(),
                trustScore: 1.0,
                isSelf: true
            });

            if (serviceWorkerReady) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'NODE_ACTIVATED',
                    nodeId: myNodeId,
                    publicKey: keys.publicKey
                });
            }

            addLog('Nœud mesh activé avec succès', 'success');
            updateStatus('online', 'Mesh Actif');
            
            document.getElementById('btn-discover').disabled = false;
            document.getElementById('btn-activate').disabled = true;
            document.getElementById('message-input').disabled = false;
            document.getElementById('btn-send').disabled = false;

            // Charger messages existants
            await loadMessages();
        }

        // =============================================================================
        // 5. PEER DISCOVERY
        // =============================================================================

        async function discoverPeers() {
            addLog('Scan du mesh network...', 'info');

            // BroadcastChannel pour découverte locale
            const channel = new BroadcastChannel('cosmic-mesh-discovery');
            channel.postMessage({
                type: 'PEER_ANNOUNCE',
                nodeId: myNodeId,
                timestamp: Date.now()
            });

            channel.onmessage = async (event) => {
                if (event.data.type === 'PEER_ANNOUNCE' && event.data.nodeId !== myNodeId) {
                    addLog(`Peer découvert: ${event.data.nodeId.substring(0,8)}...`, 'success');
                    
                    await dbSave('peers', {
                        id: event.data.nodeId,
                        lastSeen: Date.now(),
                        trustScore: 0.5,
                        method: 'broadcast',
                        isSelf: false
                    });

                    addPeerToList(event.data.nodeId, 'local');
                }
            };

            // Charger peers en cache
            const cachedPeers = await dbGetAll('peers');
            addLog(`${cachedPeers.length} peers en cache`, 'info');
            
            cachedPeers.forEach(peer => {
                if (!peer.isSelf) {
                    addPeerToList(peer.id, 'cached');
                }
            });
        }

        function addPeerToList(peerId, method) {
            if (activePeers.has(peerId)) return;

            activePeers.set(peerId, {
                id: peerId,
                method: method,
                online: method === 'local'
            });

            const peersList = document.getElementById('peers-list');
            
            if (peersList.children[0]?.textContent.includes('Aucun peer')) {
                peersList.innerHTML = '';
            }

            const peerCard = document.createElement('div');
            peerCard.className = `p-3 rounded-lg ${method === 'local' ? 'peer-online' : 'peer-offline'} bg-teal-950/20`;
            peerCard.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i data-lucide="${method === 'local' ? 'circle-dot' : 'circle'}" class="w-3 h-3 ${method === 'local' ? 'text-green-500' : 'text-gray-500'}"></i>
                        <div>
                            <div class="font-bold text-xs text-teal-400">${peerId.substring(0, 16)}...</div>
                            <div class="text-[10px] text-teal-700 mt-1">${method === 'local' ? 'En ligne' : 'Hors ligne'}</div>
                        </div>
                    </div>
                </div>
            `;

            peersList.appendChild(peerCard);
            lucide.createIcons();
            updatePeerCount();
        }

        function updatePeerCount() {
            document.getElementById('peer-count').textContent = activePeers.size;
        }

        // =============================================================================
        // 6. MESSAGING
        // =============================================================================

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text || !myNodeId) return;

            const message = {
                from: myNodeId,
                fromShort: myNodeId.substring(0, 8),
                content: text,
                timestamp: Date.now()
            };

            // Sauvegarder localement
            await dbSave('messages', message);

            // Afficher
            displayMessage(message, true);

            // Propager via Service Worker
            if (serviceWorkerReady) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'SEND_MESSAGE',
                    message: message
                });
            }

            // Broadcast local
            const channel = new BroadcastChannel('cosmic-mesh-messages');
            channel.postMessage({
                type: 'MESSAGE_PROPAGATE',
                message: message
            });

            input.value = '';
            addLog(`Message envoyé à ${activePeers.size} peers`, 'success');
        }

        function displayMessage(message, isSent) {
            const messagesArea = document.getElementById('messages-area');
            
            // Nettoyer message placeholder
            if (messagesArea.children[0]?.textContent.includes('Activez votre nœud')) {
                messagesArea.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isSent ? 'justify-end' : 'justify-start'}`;
            
            messageDiv.innerHTML = `
                <div class="message-bubble ${isSent ? 'message-sent' : 'message-received'} p-3 rounded-2xl">
                    <div class="flex items-center gap-2 mb-1">
                        <i data-lucide="user" class="w-3 h-3"></i>
                        <span class="text-[10px] font-bold opacity-70">${message.fromShort || message.from.substring(0,8)}</span>
                    </div>
                    <div class="text-sm">${message.content}</div>
                    <div class="text-[9px] opacity-50 mt-1 flex items-center gap-1">
                        <i data-lucide="clock" class="w-3 h-3"></i>
                        ${new Date(message.timestamp).toLocaleTimeString()}
                    </div>
                </div>
            `;

            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
            lucide.createIcons();
        }

        async function loadMessages() {
            const messages = await dbGetAll('messages');
            messages.sort((a, b) => a.timestamp - b.timestamp);
            
            messages.forEach(msg => {
                displayMessage(msg, msg.from === myNodeId);
            });

            addLog(`${messages.length} messages chargés depuis cache`, 'info');
        }

        // Listen for messages from other tabs
        const meshChannel = new BroadcastChannel('cosmic-mesh-messages');
        meshChannel.onmessage = async (event) => {
            if (event.data.type === 'MESSAGE_PROPAGATE' && event.data.message.from !== myNodeId) {
                await dbSave('messages', event.data.message);
                displayMessage(event.data.message, false);
                addLog(`Message reçu de ${event.data.message.fromShort}`, 'info');
            }
        };

        // =============================================================================
        // 7. UI HELPERS
        // =============================================================================

        function updateStatus(status, text) {
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            const colors = {
                'offline': 'bg-red-500',
                'online': 'bg-green-500 status-pulse',
                'syncing': 'bg-yellow-500 status-pulse'
            };

            indicator.className = `w-3 h-3 rounded-full ${colors[status] || 'bg-gray-500'}`;
            statusText.textContent = text;
        }

        function addLog(message, level = 'info') {
            const logs = document.getElementById('logs');
            const logLine = document.createElement('div');
            
            const colors = {
                'info': 'text-teal-500',
                'success': 'text-green-500',
                'error': 'text-red-500'
            };

            logLine.className = colors[level] || 'text-teal-700';
            logLine.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            logs.appendChild(logLine);
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // =============================================================================
        // 8. INITIALIZATION
        // =============================================================================

        window.addEventListener('load', async () => {
            addLog('Cosmic Mesh Network - Initialisation', 'success');
            
            try {
                await initIndexedDB();
                
                const cachedData = await dbGetAll('messages');
                const cacheSize = JSON.stringify(cachedData).length;
                document.getElementById('cache-size').textContent = `${(cacheSize / 1024).toFixed(1)} KB`;
                
            } catch (error) {
                addLog(`Erreur init DB: ${error.message}`, 'error');
            }

            window.addEventListener('online', () => {
                addLog('Connexion Internet restaurée', 'success');
                document.getElementById('offline-badge').classList.add('hidden');
            });

            window.addEventListener('offline', () => {
                addLog('Mode offline - Fonctionnement local actif', 'info');
                document.getElementById('offline-badge').classList.remove('hidden');
            });

            // Message input Enter key
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            addLog('Système prêt - Mode offline supporté', 'success');
            lucide.createIcons();
        });
    </script>
</body>
</html>
