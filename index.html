<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic P2P - Phase Video</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #050505; color: #00ffcc; font-family: 'Courier New', monospace; }
        .cosmic-border { border: 1px solid #00ffcc; box-shadow: 0 0 10px #00ffcc; }
    </style>
</head>
<body class="p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center tracking-tighter">COSMIC P2P DISCOVERY</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Section Identité -->
            <div class="cosmic-border p-6 rounded-lg bg-black">
                <h2 class="text-xl mb-4 border-b border-teal-800">1. IDENTITÉ (MATIÈRE NOIRE)</h2>
                <input id="phone" type="text" placeholder="Numéro de téléphone" class="w-full p-2 bg-gray-900 border border-teal-900 mb-4 rounded">
                <button onclick="initIdentity()" class="w-full bg-teal-900 hover:bg-teal-700 p-2 rounded transition">ACTIVER NODE</button>
                <div id="status" class="mt-4 text-xs text-gray-400">En attente d'activation...</div>
            </div>

            <!-- Section Appel -->
            <div class="cosmic-border p-6 rounded-lg bg-black">
                <h2 class="text-xl mb-4 border-b border-teal-800">2. INTRICATION (APPEL)</h2>
                <input id="targetPhone" type="text" placeholder="Numéro du contact" class="w-full p-2 bg-gray-900 border border-teal-900 mb-4 rounded">
                <button onclick="startCall()" class="w-full bg-purple-900 hover:bg-purple-700 p-2 rounded transition text-white">LANCER L'APPEL</button>
            </div>
        </div>

        <div class="mt-8 grid grid-cols-2 gap-4">
            <div class="relative">
                <p class="absolute top-2 left-2 text-xs bg-black p-1">LOCAL_STREAM</p>
                <video id="localVideo" autoplay muted class="w-full rounded cosmic-border bg-gray-950 h-48 object-cover"></video>
            </div>
            <div class="relative">
                <p class="absolute top-2 left-2 text-xs bg-black p-1">REMOTE_STREAM</p>
                <video id="remoteVideo" autoplay class="w-full rounded cosmic-border bg-gray-950 h-48 object-cover"></video>
            </div>
        </div>
    </div>

    <script>
        // Initialisation de la DHT (GunDB utilise un réseau de pairs pour discovery)
        const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']); 
        let myId = null;
        let pc = null;

        async function hashPhone(phone) {
            const msgUint8 = new TextEncoder().encode(phone.replace(/\s/g, ''));
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function initIdentity() {
            const phone = document.getElementById('phone').value;
            if(!phone) return alert("Phone requis");
            
            myId = await hashPhone(phone);
            document.getElementById('status').innerText = `NODE ACTIF : ${myId.substring(0,16)}...`;
            
            // Écouter les tentatives d'appels entrants sur notre hash (Matière Noire)
            gun.get('cosmic-p2p').get(myId).get('offer').on(async (data) => {
                if(data && !pc) {
                    console.log("Offre reçue, intrication en cours...");
                    handleOffer(JSON.parse(data));
                }
            });

            // Start Camera
            const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            document.getElementById('localVideo').srcObject = stream;
        }

        function createPeerConnection(targetId) {
            pc = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            pc.onicecandidate = (e) => {
                if(e.candidate) {
                    gun.get('cosmic-p2p').get(targetId).get('candidates').set(JSON.stringify(e.candidate));
                }
            };

            pc.ontrack = (e) => {
                document.getElementById('remoteVideo').srcObject = e.streams[0];
            };

            const stream = document.getElementById('localVideo').srcObject;
            stream.getTracks().forEach(track => pc.addTrack(track, stream));
            return pc;
        }

        async function startCall() {
            const target = document.getElementById('targetPhone').value;
            const targetId = await hashPhone(target);
            
            pc = createPeerConnection(targetId);
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            
            // Publier l'offre sur la DHT (GunDB) à l'adresse du hash cible
            gun.get('cosmic-p2p').get(targetId).get('offer').put(JSON.stringify(offer));
            
            // Attendre la réponse
            gun.get('cosmic-p2p').get(myId).get('answer').on(async (data) => {
                if(data) await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(data)));
            });

            // Échanger les ICE candidates
            gun.get('cosmic-p2p').get(myId).get('candidates').map().on((data) => {
                if(data) pc.addIceCandidate(new RTCIceCandidate(JSON.parse(data)));
            });
        }

        async function handleOffer(offer) {
            const senderId = myId; // Dans un flux réel, on extrairait l'ID de l'appelant
            pc = createPeerConnection(senderId); // simplifié pour le test
            await pc.setRemoteDescription(new RTCSessionDescription(offer));
            
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            
            // On renvoie l'answer (ici on simplifie le routage pour la démo)
            // Dans une vraie app, chaque node a son propre slot de réponse
            gun.get('cosmic-p2p').get(offer.senderId || 'global-response').get('answer').put(JSON.stringify(answer));
        }
    </script>
</body>
</html>